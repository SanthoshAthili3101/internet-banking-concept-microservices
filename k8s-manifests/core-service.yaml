  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: core-service
    namespace: fintech-prod
  spec:
    replicas: 1 # Scale to 2 for high availability
    selector:
      matchLabels:
        app: core-service
    template:
      metadata:
        labels:
          app: core-service
      spec:
        containers:
        - name: core-service
          image: 982081054052.dkr.ecr.ap-south-1.amazonaws.com/fintech/banking-core:v1 # Make sure to push this image to ECR or DockerHub first!
          imagePullPolicy: IfNotPresent
          ports:
          - containerPort: 8080
          env:
          - name: SPRING_DATASOURCE_URL
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: db-host
                optional: false 
            # We construct the full JDBC URL using the host from secret
          - name: SPRING_DATASOURCE_URL_FULL
            value: "jdbc:mysql://$(SPRING_DATASOURCE_URL)/banking_core_db"
          - name: SPRING_DATASOURCE_USERNAME
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: db-username
          - name: SPRING_DATASOURCE_PASSWORD
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: db-password
          # Trick to use the composed URL variable
          command: ["/bin/sh", "-c"]
          args: ["java -jar app.jar --spring.datasource.url=jdbc:mysql://$(SPRING_DATASOURCE_URL)/banking_core_db"]
  ---
  apiVersion: v1
  kind: Service
  metadata:
    name: internet-banking-core-service # Must match the Feign Client Name!
    namespace: fintech-prod
  spec:
    selector:
      app: core-service
    type: ClusterIP # Internal only
    ports:
      - port: 8080 # Service Port
        targetPort: 8080 # Container Port